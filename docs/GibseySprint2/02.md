# 02\_stargate\_quickstart.md – **Turn Cassandra into a Web‑Native API**

> **Sprint 2 – Block 1–2 h**  |  Author ✍️ ***You + Gemini***
>
> **Goal:** Spin up Stargate in front of Cassandra so all services (Faust, RAG, Chat, UI) talk pure HTTP/JSON instead of CQL.  *Five minutes from container boot to first successful `curl`.*

---

## 1 Why Stargate?

| Pain without                                                        | Relief with Stargate                                                |
| ------------------------------------------------------------------- | ------------------------------------------------------------------- |
| Each micro‑service needs a CQL driver, pooled auth, token rotation. | **Single REST endpoint** (`/v2/keyspaces/...`) – language‑agnostic. |
| Hard to expose CQL on the public Internet safely.                   | Stargate handles auth tokens & CORS; you gatekeeper with Nginx.     |
| Data‑model drift → manual schema migrations per app.                | Stargate’s **GraphQL & JSON Schema** endpoints auto‑expose tables.  |

---

## 2 Prerequisites

* **Block 01** is running – Cassandra container reachable at `cassandra:9042`.
* Ports you can open: 8080 (REST), 8081 (GraphQL), 8082 (Docs), 8084 (Metrics), 9043 (gRPC).
* `.env` file in repo root with:

  ```env
  STARGATE_CLUSTER_NAME=gibsey-local
  STARGATE_AUTH_TOKEN=dev-super-secret
  ```

---

## 3 Docker Service Definition

Add to **`infra/stargate.yml`** (or extend `docker-compose.cdc.yml`):

```yaml
services:
  stargate:
    image: stargateio/stargate-4_1:latest
    depends_on: [cassandra]
    environment:
      - CLUSTER_NAME=${STARGATE_CLUSTER_NAME}
      - CLUSTER_VERSION=4.1
      - SEED=cassandra
      - ENABLE_AUTH=true
      - DEVELOPER_MODE=true          # disables OIDC for local dev
      - JWT_SECRET=${STARGATE_AUTH_TOKEN}
    ports:
      - "8080:8080"   # REST
      - "8081:8081"   # GraphQL
      - "8082:8082"   # Docs UI
      - "8084:8084"   # Prometheus metrics
```

Bring it up:

```bash
docker compose -f infra/stargate.yml up -d stargate
```

> **Cold‑start ≈ 45‑60 s** (wait for `Started StargateMain` log).

---

## 4 Create an Auth Token (optional for dev)

If you left `DEVELOPER_MODE=true`, Stargate auto‑generates a static JWT matching `$STARGATE_AUTH_TOKEN`.  For prod you’d POST credentials:

```bash
curl -X POST localhost:8081/v1/auth \
     -d '{"username":"cassandra","password":"cassandra"}'
```

→ returns `{ "authToken":"<jwt>" }`

---

## 5 CRUD Walk‑through

Set env helper:

```bash
export SG="http://localhost:8080"
export TOKEN="$STARGATE_AUTH_TOKEN"
```

### 5.1 Insert a Page

```bash
curl -X POST "$SG/v2/keyspaces/gibsey/pages" \
     -H "X-Cassandra-Token:$TOKEN" \
     -H "Content-Type: application/json" \
     -d '{"page_id": "42", "body": "The fox jumped."}'
```

Expect `201 Created`.

### 5.2 Read it Back

```bash
curl "$SG/v2/keyspaces/gibsey/pages/42" -H "X-Cassandra-Token:$TOKEN"
```

→ `{ "page_id":"42", "body":"The fox jumped." }`

### 5.3 Bulk Query (GraphQL)

```bash
curl -X POST "$SG/graphql" -H "X-Cassandra-Token:$TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"query":"{ gibsey_pages(value:{page_id:42}){values{body}} }"}'
```

---

## 6 Schema Migrations via Stargate

Instead of `cqlsh`, you can PATCH JSON:

```bash
curl -X POST "$SG/v2/schemas/keyspaces/gibsey/tables" \
     -H "X-Cassandra-Token:$TOKEN" -H "Content-Type: application/json" \
     -d '{
       "name":"page_vectors",
       "ifNotExists":true,
       "columnDefinitions":[
         {"name":"page_id","typeDefinition":"text","static":false,"isPartitionKey":true},
         {"name":"vector","typeDefinition":"vector<float,768>","static":false}
       ]
     }'
```

---

## 7 Health, Metrics, & Tracing

* **Liveness:** `GET /v2/ops/health` → `{"status":"UP"}`
* **Prometheus:** scrape `http://localhost:8084/metrics`
* **Tracing:** add header `x-cassandra-trace: true` on any REST call to get a trace ID in response.

---

## 8 Troubleshooting

| Symptom                | Cause                   | Fix                                               |
| ---------------------- | ----------------------- | ------------------------------------------------- |
| `401 Unauthorized`     | Missing/invalid token   | Export `TOKEN` or POST `/auth` again.             |
| `502` from Nginx proxy | Stargate not fully up   | Wait; check logs `docker logs -f stargate`.       |
| Insert hangs > 3 s     | Cassandra back‑pressure | Tune `commitlog_sync_period` or mount SSD volume. |

---

## 9 Next‑Step Hand‑Off

1. Confirm `curl` works → copy JSON output into chat for sanity.
2. Tag the commit: `git tag sprint2-stargate-ready`.
3. Ping Gemini: *“Begin 03\_faust\_worker.md – assume Stargate at \$SG, token in env.”*

*End of file 🚀*
