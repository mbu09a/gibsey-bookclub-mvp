# 02\_stargate\_quickstart.md â€“ **Turn Cassandra into a Webâ€‘Native API**

> **Sprintâ€¯2 â€“ Blockâ€¯1â€“2â€¯h**  |  Author âœï¸ ***You + Gemini***
>
> **Goal:** Spin up Stargate in front of Cassandra so all services (Faust, RAG, Chat, UI) talk pure HTTP/JSON instead of CQL.  *Five minutes from container boot to first successful `curl`.*

---

## 1â€‚Why Stargate?

| Pain without                                                        | Relief with Stargate                                                |
| ------------------------------------------------------------------- | ------------------------------------------------------------------- |
| Each microâ€‘service needs a CQL driver, pooled auth, token rotation. | **Single REST endpoint** (`/v2/keyspaces/...`) â€“ languageâ€‘agnostic. |
| Hard to expose CQL on the public Internet safely.                   | Stargate handles auth tokens & CORS; you gatekeeper with Nginx.     |
| Dataâ€‘model drift â†’ manual schema migrations per app.                | Stargateâ€™s **GraphQL & JSON Schema** endpoints autoâ€‘expose tables.  |

---

## 2â€‚Prerequisites

* **BlockÂ 01** is running â€“ Cassandra container reachable at `cassandra:9042`.
* Ports you can open: 8080 (REST), 8081 (GraphQL), 8082 (Docs), 8084 (Metrics), 9043 (gRPC).
* `.env` file in repo root with:

  ```env
  STARGATE_CLUSTER_NAME=gibsey-local
  STARGATE_AUTH_TOKEN=dev-super-secret
  ```

---

## 3â€‚Docker Service Definition

Add to **`infra/stargate.yml`** (or extend `docker-compose.cdc.yml`):

```yaml
services:
  stargate:
    image: stargateio/stargate-4_1:latest
    depends_on: [cassandra]
    environment:
      - CLUSTER_NAME=${STARGATE_CLUSTER_NAME}
      - CLUSTER_VERSION=4.1
      - SEED=cassandra
      - ENABLE_AUTH=true
      - DEVELOPER_MODE=true          # disables OIDC for local dev
      - JWT_SECRET=${STARGATE_AUTH_TOKEN}
    ports:
      - "8080:8080"   # REST
      - "8081:8081"   # GraphQL
      - "8082:8082"   # Docs UI
      - "8084:8084"   # Prometheus metrics
```

Bring it up:

```bash
docker compose -f infra/stargate.yml up -d stargate
```

> **Coldâ€‘start â‰ˆ 45â€‘60â€¯s** (wait for `Started StargateMain` log).

---

## 4â€‚Create an Auth Token (optional for dev)

If you left `DEVELOPER_MODE=true`, Stargate autoâ€‘generates a static JWT matching `$STARGATE_AUTH_TOKEN`.  For prod youâ€™d POST credentials:

```bash
curl -X POST localhost:8081/v1/auth \
     -d '{"username":"cassandra","password":"cassandra"}'
```

â†’ returns `{ "authToken":"<jwt>" }`

---

## 5â€‚CRUD Walkâ€‘through

Set env helper:

```bash
export SG="http://localhost:8080"
export TOKEN="$STARGATE_AUTH_TOKEN"
```

### 5.1â€‚Insert a Page

```bash
curl -X POST "$SG/v2/keyspaces/gibsey/pages" \
     -H "X-Cassandra-Token:$TOKEN" \
     -H "Content-Type: application/json" \
     -d '{"page_id": "42", "body": "The fox jumped."}'
```

Expect `201 Created`.

### 5.2â€‚Read it Back

```bash
curl "$SG/v2/keyspaces/gibsey/pages/42" -H "X-Cassandra-Token:$TOKEN"
```

â†’ `{ "page_id":"42", "body":"The fox jumped." }`

### 5.3â€‚Bulk Query (GraphQL)

```bash
curl -X POST "$SG/graphql" -H "X-Cassandra-Token:$TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"query":"{ gibsey_pages(value:{page_id:42}){values{body}} }"}'
```

---

## 6â€‚Schema Migrations via Stargate

Instead of `cqlsh`, you can PATCH JSON:

```bash
curl -X POST "$SG/v2/schemas/keyspaces/gibsey/tables" \
     -H "X-Cassandra-Token:$TOKEN" -H "Content-Type: application/json" \
     -d '{
       "name":"page_vectors",
       "ifNotExists":true,
       "columnDefinitions":[
         {"name":"page_id","typeDefinition":"text","static":false,"isPartitionKey":true},
         {"name":"vector","typeDefinition":"vector<float,768>","static":false}
       ]
     }'
```

---

## 7â€‚Health, Metrics, & Tracing

* **Liveness:** `GET /v2/ops/health` â†’ `{"status":"UP"}`
* **Prometheus:** scrape `http://localhost:8084/metrics`
* **Tracing:** add header `x-cassandra-trace: true` on any REST call to get a trace ID in response.

---

## 8â€‚Troubleshooting

| Symptom                | Cause                   | Fix                                               |
| ---------------------- | ----------------------- | ------------------------------------------------- |
| `401 Unauthorized`     | Missing/invalid token   | Export `TOKEN` or POST `/auth` again.             |
| `502` from Nginx proxy | Stargate not fully up   | Wait; check logs `docker logs -f stargate`.       |
| Insert hangs > 3â€¯s     | Cassandra backâ€‘pressure | Tune `commitlog_sync_period` or mount SSD volume. |

---

## 9â€‚Nextâ€‘Step Handâ€‘Off

1. Confirm `curl` works â†’ copy JSON output into chat for sanity.
2. Tag the commit: `git tag sprint2-stargate-ready`.
3. Ping Gemini: *â€œBeginÂ 03\_faust\_worker.md â€“ assume Stargate at \$SG, token in env.â€*

*End of file ğŸš€*
